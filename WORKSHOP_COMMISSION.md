# ワークショップ(講師用)

これから商品情報(Item)に送料を追加します。

1. 開発用のブランチを作成
   1. 左下にある`main`と表示されたブランチ名をクリックする
   2. `Create new branch`を選択する
   3. 表示されたブランチに`feature/****`と表示されていることを確認して、`Enter`を押す
   4. 左下のブランチ名が`feature/****`に変わっていることを確認する
2. 変更前の動作確認
   1. [https://localhost:8000/docs](https://localhost:8000/docs)にアクセスする
   2. POST /itemsを開く
   3. `Try it out`を押す
   4. Bodyの内容は変更せずに`Execute`を押す
   5. `Server responses`に`200`と表示されていることを確認する。
   6. `Response body`にリクエスト時の内容が表示されていることを確認する
   7. GET /itemsを開く
   8. `Try it out`を押す
   9. `Execute`を押す
   10. `Server responses`に`200`と表示されていることを確認する。
   11. `Response body`に作成時の内容が表示されていることを確認する
3. モデルの変更
   1. [api/models/item.py](api/models/item.py)を開く
   2. [モデルの変更](#モデルの変更)のセクションを参考にコードを追加する
4. スキーマの変更
   1. [api/schemas/item.py](api/schemas/item.py)を開く
   2. [スキーマの変更](#スキーマの変更)のセクションを参考にコードを追加する
5. CRUDSの変更
   1. [api/cruds/item.py](api/cruds/item.py)を開く
   2. [CRUDSの変更](#crudsの変更)のセクションを参考にコードを追加する
6. マイグレーションファイルの作成
   1. 「マイグレーションファイルの作成」のセクションを参考にコマンドを実行する
   2. `alembic/versions/`に`****_add_commission.py`が作成されていることを確認して、ファイルを開く
   3. [マイグレーションファイルの作成](#マイグレーションファイルの作成)のセクションを参考にコードを追加する
7. DBのマイグレーションを実行
   1. [DBマイグレーションの実行](#dbマイグレーションの実行)のセクションを参考にコマンドを実行する
8. 変更後のドキュメントを確認
   1. POST /itemsを開く
   2. 送料の項目が追加されていることを確認する
   3. GET /itemsを開く
   4. 送料の項目が追加されていることを確認する
9. プルリクエストの作成
   1.  

## モデルの変更

このワークショップではORMを使ってデータベースを操作します。\
モデルは、データベースのテーブルと対応しています。

まずはじめにモデルに送料を表すフィールドを追加します。
追加方法は、[item.py](api/models/item.py)に以下のコードを追記してください。

```diff
```diff
class Item(Base):
    __tablename__ = "items"

    id = Column(Integer, primary_key=True)
    name = Column(String(1024))
    price = Column(Integer)
+   commission = Column(Integer, default=0)
```

## スキーマの変更

スキーマにも同じように送料を追加します。\
スキーマは、APIのリクエストやレスポンスの形式を定義しています。

[item.py](api/schemas/item.py)に以下のコードを追記してください。

```diff
class ItemBase(BaseModel):
    name: str = Field(..., example="一眼レフカメラ", description="商品名")
    price: int = Field(..., example=1000, description="価格")
+   commission: int = Field(0, example=100, description="手数料")
```

## CRUDSの変更

CRUDSにも同じように送料を追加します。\
CRUDSは、データベースの操作を定義しています。

[item.py](api/cruds/item.py)に以下のコードを追記してください。

```diff
def update_item(
    db: Session,
    item: item_schema.ItemCreate,
    original: item_model.Item,
) -> item_model.Item:
    original.name = item.name
    original.price = item.price
+   commission = item.commission
    db.commit()
    db.refresh(original)
    return original
```

## マイグレーションファイルの作成

Modelに変更を加えたので、データベースのテーブルの定義も変更する必要があります。\
データベースのテーブルの定義を変更するには、マイグレーションファイルを作成する必要があります。

マイグレーションファイルを作成するには、以下のコマンドを実行してください。

```shell
make new-migrate MESSAGE="add commission"
```

コマンドの実行に成功すると、`alembic/versions`ディレクトリにマイグレーションファイルが作成されます。\
何らかのデータをテーブルに登録している場合も想定して既存データのリペア処理を追加する必要がありますが、すべて0円になるよなクエリを既述します。

`xxxxx_add_commission.py`ファイルを開き、以下のコードを追記してください。\
`xxxxx`の部分はハッシュ値ですので、実際には異なる値になります。

```diff
def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column("items", sa.Column("commission", sa.Integer(), nullable=True))
    # ### end Alembic commands ###
+   op.execute("UPDATE items SET commission = 0")
```

## DBマイグレーションの実行

マイグレーションファイルを作成したので、実際にデータベースに反映させます。\
以下のコマンドを実行してください。

```shell
make migrate
```

これで実際のデータベースにテーブルの変更が反映されました。
